name: Deploy Frontend to cPanel

on:
  push:
    branches: [ main ]
    paths:
      - 'Frontend/**'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-frontend
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install lftp (for remote backup)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp zip

      - name: FTP environment diagnostics
        env:
          FTP_HOST: ${{ secrets.CPANEL_FTP_HOST }}
          FTP_USER: ${{ secrets.CPANEL_FTP_USERNAME }}
          FTP_PASS: ${{ secrets.CPANEL_FTP_PASSWORD }}
          FTP_DIR: ${{ secrets.CPANEL_FTP_SERVERDIR }}
        run: |
          echo "Connecting to FTP to show pwd and root listing (masking may hide names)"
          lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "set ssl:verify-certificate no; pwd; cls -1; bye" || echo "Root listing failed"
          if [ -n "$FTP_DIR" ]; then
            echo "Attempting listing of specified FTP_DIR='$FTP_DIR'"
            lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "set ssl:verify-certificate no; cd \"$FTP_DIR\"; pwd; cls -1; bye" || echo "Specified FTP_DIR listing failed (likely unnecessary)."
          else
            echo "No FTP_DIR secret set (will deploy to root)."
          fi

      - name: Backup existing remote directory (conditional)
        env:
          FTP_HOST: ${{ secrets.CPANEL_FTP_HOST }}
          FTP_USER: ${{ secrets.CPANEL_FTP_USERNAME }}
          FTP_PASS: ${{ secrets.CPANEL_FTP_PASSWORD }}
          FTP_DIR: ${{ secrets.CPANEL_FTP_SERVERDIR }}
        run: |
          set -e
          TS=$(date +%Y%m%d-%H%M%S)
          mkdir -p remote_current
          echo "Downloading current remote contents (excluding Backup & uploads)"
          TARGET_DIR="$FTP_DIR"
          if [ -z "$TARGET_DIR" ] || [ "$TARGET_DIR" = "." ]; then
            TARGET_DIR="."  # treat blank secret as root
          fi
          echo "Attempting mirror of '$TARGET_DIR'"
          if lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "set ssl:verify-certificate no; cd \"$TARGET_DIR\"; pwd; mirror . remote_current --exclude Backup --exclude uploads; bye"; then
            echo "Mirror succeeded from '$TARGET_DIR'"
          else
            echo "Primary mirror FAILED for '$TARGET_DIR'"
            # Fallback possibilities: inside public_html or already chrooted inside subdomain
            echo "Trying fallback path options..."
            for FALLBACK in . "public_html" "public_html/$TARGET_DIR"; do
              echo "Testing fallback '$FALLBACK'"
              if lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "set ssl:verify-certificate no; cd \"$FALLBACK\"; pwd; mirror . remote_current --exclude Backup --exclude uploads; bye"; then
                echo "Using fallback directory '$FALLBACK' for backup"
                TARGET_DIR="$FALLBACK"
                break
              fi
            done
          fi
          echo "Packaging backup (if any files)"
          cd remote_current
          zip -r "site-backup-$TS.zip" . || echo "No files to zip"
          cd ..
          if [ -f remote_current/site-backup-$TS.zip ]; then
            echo "Uploading backup zip to Backup/ folder on server (under $TARGET_DIR)"
            lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "set ssl:verify-certificate no; cd \"$TARGET_DIR\"; mkdir -p Backup; cd Backup; put remote_current/site-backup-$TS.zip; bye"
            echo "Backup completed: site-backup-$TS.zip"
          else
            echo "No backup zip created (remote empty or inaccessible)."
          fi

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: Frontend
        run: bun install --frozen-lockfile

      - name: Build
        working-directory: Frontend
        run: bun run build

      - name: Upload build artifact (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: Frontend/build

      - name: Deploy build via lftp (manual)
        env:
          FTP_HOST: ${{ secrets.CPANEL_FTP_HOST }}
          FTP_USER: ${{ secrets.CPANEL_FTP_USERNAME }}
          FTP_PASS: ${{ secrets.CPANEL_FTP_PASSWORD }}
          FTP_DIR: ${{ secrets.CPANEL_FTP_SERVERDIR }}
        run: |
          set -e
          TARGET_DIR="$FTP_DIR"
          if [ -z "$TARGET_DIR" ] || [ "$TARGET_DIR" = "." ]; then
            TARGET_DIR="."  # root
          fi
          echo "Starting deploy to '$TARGET_DIR'"
          # Attempt direct deploy; if fails try common fallbacks
          if lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "set ssl:verify-certificate no; cd \"$TARGET_DIR\"; mirror -R Frontend/build . --delete --exclude Backup --exclude uploads --exclude .git --exclude node_modules; bye"; then
            echo "Deployment succeeded to '$TARGET_DIR'"
          else
            echo "Primary deploy failed for '$TARGET_DIR'. Trying fallbacks..."
            for FALLBACK in . "public_html" "public_html/$TARGET_DIR"; do
              echo "Testing deploy fallback '$FALLBACK'"
              if lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "set ssl:verify-certificate no; cd \"$FALLBACK\"; mirror -R Frontend/build . --delete --exclude Backup --exclude uploads --exclude .git --exclude node_modules; bye"; then
                echo "Deployment succeeded using fallback '$FALLBACK'"
                break
              fi
            done
          fi
          echo "Deployment complete"
