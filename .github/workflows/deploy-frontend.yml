name: Deploy Frontend to cPanel

on:
  push:
    branches: [ main ]
    paths:
      - 'Frontend/**'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-frontend
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install lftp (for remote backup)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp zip

      - name: List FTP root (debug)
        env:
          FTP_HOST: ${{ secrets.CPANEL_FTP_HOST }}
          FTP_USER: ${{ secrets.CPANEL_FTP_USERNAME }}
          FTP_PASS: ${{ secrets.CPANEL_FTP_PASSWORD }}
        run: |
          echo "Listing FTP root to confirm directory names"
          lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "set ssl:verify-certificate no; cls -1; bye"

      - name: Verify or create target directory (debug)
        env:
          FTP_HOST: ${{ secrets.CPANEL_FTP_HOST }}
          FTP_USER: ${{ secrets.CPANEL_FTP_USERNAME }}
          FTP_PASS: ${{ secrets.CPANEL_FTP_PASSWORD }}
          FTP_DIR: ${{ secrets.CPANEL_FTP_SERVERDIR }}
        run: |
          echo "Ensuring target directory '$FTP_DIR' exists (creating if missing)"
          lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "set ssl:verify-certificate no; mkdir -p \"$FTP_DIR\"; cls -1 \"$FTP_DIR\"; bye"

      - name: Backup existing remote directory (conditional)
        env:
          FTP_HOST: ${{ secrets.CPANEL_FTP_HOST }}
          FTP_USER: ${{ secrets.CPANEL_FTP_USERNAME }}
          FTP_PASS: ${{ secrets.CPANEL_FTP_PASSWORD }}
          FTP_DIR: ${{ secrets.CPANEL_FTP_SERVERDIR }}
        run: |
          set -e
          TS=$(date +%Y%m%d-%H%M%S)
          mkdir -p remote_current
          echo "Downloading current remote contents (excluding Backup & uploads)"
          if lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "set ssl:verify-certificate no; mirror \"$FTP_DIR\" remote_current --exclude Backup --exclude uploads; bye"; then
            echo "Packaging backup"
            cd remote_current
            zip -r "site-backup-$TS.zip" . || echo "No files to zip"
            cd ..
            if [ -f remote_current/site-backup-$TS.zip ]; then
              echo "Uploading backup zip to Backup/ folder on server"
              lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "set ssl:verify-certificate no; mkdir -p \"$FTP_DIR/Backup\"; cd \"$FTP_DIR/Backup\"; put remote_current/site-backup-$TS.zip; bye"
              echo "Backup completed: site-backup-$TS.zip"
            else
              echo "Backup zip missing (empty remote). Skipping upload."
            fi
          else
            echo "WARNING: Could not mirror '$FTP_DIR'. Skipping backup."
          fi

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: Frontend
        run: bun install --frozen-lockfile

      - name: Build
        working-directory: Frontend
        run: bun run build

      - name: Upload build artifact (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: Frontend/build

      - name: Deploy build via lftp (manual)
        env:
          FTP_HOST: ${{ secrets.CPANEL_FTP_HOST }}
          FTP_USER: ${{ secrets.CPANEL_FTP_USERNAME }}
          FTP_PASS: ${{ secrets.CPANEL_FTP_PASSWORD }}
          FTP_DIR: ${{ secrets.CPANEL_FTP_SERVERDIR }}
        run: |
          set -e
          echo "Starting lftp reverse mirror to $FTP_DIR"
          # --reverse uploads local -> remote; --delete removes remote files no longer present (excluding patterns)
          # Exclude Backup and uploads to preserve backups & user content
          lftp -u "$FTP_USER","$FTP_PASS" "$FTP_HOST" -e "set ssl:verify-certificate no; mirror -R Frontend/build $FTP_DIR --delete --exclude Backup --exclude uploads --exclude .git --exclude node_modules; bye"
          echo "Deployment complete"
